#include "teapot.h"
#include "gl_widget.h"
#include "patch.h"



static float control_points[] = {
    //    0
    -80.00,    0.00,   30.00,
    -80.00,  -44.80,   30.00,
    -44.80,  -80.00,   30.00,
      0.00,  -80.00,   30.00,
    -80.00,    0.00,   12.00,
    -80.00,  -44.80,   12.00,
    -44.80,  -80.00,   12.00,
      0.00,  -80.00,   12.00,
    -60.00,    0.00,    3.00,
    -60.00,  -33.60,    3.00,
    -33.60,  -60.00,    3.00,
      0.00,  -60.00,    3.00,
    -60.00,    0.00,    0.00,
    -60.00,  -33.60,    0.00,
    -33.60,  -60.00,    0.00,
      0.00,  -60.00,    0.00,
    // 1
     0.00,  -80.00,   30.00,
    44.80,  -80.00,   30.00,
    80.00,  -44.80,   30.00,
    80.00,    0.00,   30.00,
     0.00,  -80.00,   12.00,
    44.80,  -80.00,   12.00,
    80.00,  -44.80,   12.00,
    80.00,    0.00,   12.00,
     0.00,  -60.00,    3.00,
    33.60,  -60.00,    3.00,
    60.00,  -33.60,    3.00,
    60.00,    0.00,    3.00,
     0.00,  -60.00,    0.00,
    33.60,  -60.00,    0.00,
    60.00,  -33.60,    0.00,
    60.00,    0.00,    0.00,
    // 2
    -60.00,    0.00,   90.00,
    -60.00,  -33.60,   90.00,
    -33.60,  -60.00,   90.00,
      0.00,  -60.00,   90.00,
    -70.00,    0.00,   69.00,
    -70.00,  -39.20,   69.00,
    -39.20,  -70.00,   69.00,
      0.00,  -70.00,   69.00,
    -80.00,    0.00,   48.00,
    -80.00,  -44.80,   48.00,
    -44.80,  -80.00,   48.00,
      0.00,  -80.00,   48.00,
    -80.00,    0.00,   30.00,
    -80.00,  -44.80,   30.00,
    -44.80,  -80.00,   30.00,
      0.00,  -80.00,   30.00,
    // 3
     0.00,  -60.00,   90.00,
    33.60,  -60.00,   90.00,
    60.00,  -33.60,   90.00,
    60.00,    0.00,   90.00,
     0.00,  -70.00,   69.00,
    39.20,  -70.00,   69.00,
    70.00,  -39.20,   69.00,
    70.00,    0.00,   69.00,
     0.00,  -80.00,   48.00,
    44.80,  -80.00,   48.00,
    80.00,  -44.80,   48.00,
    80.00,    0.00,   48.00,
     0.00,  -80.00,   30.00,
    44.80,  -80.00,   30.00,
    80.00,  -44.80,   30.00,
    80.00,    0.00,   30.00,
    // 4
    -56.00,    0.00,   90.00,
    -56.00,  -31.36,   90.00,
    -31.36,  -56.00,   90.00,
      0.00,  -56.00,   90.00,
    -53.50,    0.00,   95.25,
    -53.50,  -29.96,   95.25,
    -29.96,  -53.50,   95.25,
      0.00,  -53.50,   95.25,
    -57.50,    0.00,   95.25,
    -57.50,  -32.20,   95.25,
    -32.20,  -57.50,   95.25,
      0.00,  -57.50,   95.25,
    -60.00,    0.00,   90.00,
    -60.00,  -33.60,   90.00,
    -33.60,  -60.00,   90.00,
      0.00,  -60.00,   90.00,
    // 5
     0.00,  -56.00,   90.00,
    31.36,  -56.00,   90.00,
    56.00,  -31.36,   90.00,
    56.00,    0.00,   90.00,
     0.00,  -53.50,   95.25,
    29.96,  -53.50,   95.25,
    53.50,  -29.96,   95.25,
    53.50,    0.00,   95.25,
     0.00,  -57.50,   95.25,
    32.20,  -57.50,   95.25,
    57.50,  -32.20,   95.25,
    57.50,    0.00,   95.25,
     0.00,  -60.00,   90.00,
    33.60,  -60.00,   90.00,
    60.00,  -33.60,   90.00,
    60.00,    0.00,   90.00,
    // 6
    80.00,    0.00,   30.00,
    80.00,   44.80,   30.00,
    44.80,   80.00,   30.00,
     0.00,   80.00,   30.00,
    80.00,    0.00,   12.00,
    80.00,   44.80,   12.00,
    44.80,   80.00,   12.00,
     0.00,   80.00,   12.00,
    60.00,    0.00,    3.00,
    60.00,   33.60,    3.00,
    33.60,   60.00,    3.00,
     0.00,   60.00,    3.00,
    60.00,    0.00,    0.00,
    60.00,   33.60,    0.00,
    33.60,   60.00,    0.00,
     0.00,   60.00,    0.00,
    // 7
      0.00,   80.00,   30.00,
    -44.80,   80.00,   30.00,
    -80.00,   44.80,   30.00,
    -80.00,    0.00,   30.00,
      0.00,   80.00,   12.00,
    -44.80,   80.00,   12.00,
    -80.00,   44.80,   12.00,
    -80.00,    0.00,   12.00,
      0.00,   60.00,    3.00,
    -33.60,   60.00,    3.00,
    -60.00,   33.60,    3.00,
    -60.00,    0.00,    3.00,
      0.00,   60.00,    0.00,
    -33.60,   60.00,    0.00,
    -60.00,   33.60,    0.00,
    -60.00,    0.00,    0.00,
    // 8
    60.00,    0.00,   90.00,
    60.00,   33.60,   90.00,
    33.60,   60.00,   90.00,
     0.00,   60.00,   90.00,
    70.00,    0.00,   69.00,
    70.00,   39.20,   69.00,
    39.20,   70.00,   69.00,
     0.00,   70.00,   69.00,
    80.00,    0.00,   48.00,
    80.00,   44.80,   48.00,
    44.80,   80.00,   48.00,
     0.00,   80.00,   48.00,
    80.00,    0.00,   30.00,
    80.00,   44.80,   30.00,
    44.80,   80.00,   30.00,
     0.00,   80.00,   30.00,
    // 9
      0.00,   60.00,   90.00,
    -33.60,   60.00,   90.00,
    -60.00,   33.60,   90.00,
    -60.00,    0.00,   90.00,
      0.00,   70.00,   69.00,
    -39.20,   70.00,   69.00,
    -70.00,   39.20,   69.00,
    -70.00,    0.00,   69.00,
      0.00,   80.00,   48.00,
    -44.80,   80.00,   48.00,
    -80.00,   44.80,   48.00,
    -80.00,    0.00,   48.00,
      0.00,   80.00,   30.00,
    -44.80,   80.00,   30.00,
    -80.00,   44.80,   30.00,
    -80.00,    0.00,   30.00,
    // 10
    56.00,    0.00,   90.00,
    56.00,   31.36,   90.00,
    31.36,   56.00,   90.00,
     0.00,   56.00,   90.00,
    53.50,    0.00,   95.25,
    53.50,   29.96,   95.25,
    29.96,   53.50,   95.25,
     0.00,   53.50,   95.25,
    57.50,    0.00,   95.25,
    57.50,   32.20,   95.25,
    32.20,   57.50,   95.25,
     0.00,   57.50,   95.25,
    60.00,    0.00,   90.00,
    60.00,   33.60,   90.00,
    33.60,   60.00,   90.00,
     0.00,   60.00,   90.00,
    // 11
      0.00,   56.00,   90.00,
    -31.36,   56.00,   90.00,
    -56.00,   31.36,   90.00,
    -56.00,    0.00,   90.00,
      0.00,   53.50,   95.25,
    -29.96,   53.50,   95.25,
    -53.50,   29.96,   95.25,
    -53.50,    0.00,   95.25,
      0.00,   57.50,   95.25,
    -32.20,   57.50,   95.25,
    -57.50,   32.20,   95.25,
    -57.50,    0.00,   95.25,
      0.00,   60.00,   90.00,
    -33.60,   60.00,   90.00,
    -60.00,   33.60,   90.00,
    -60.00,    0.00,   90.00,
    // 12
     -64.00,    0.00,   75.00,
     -64.00,   12.00,   75.00,
     -60.00,   12.00,   84.00,
     -60.00,    0.00,   84.00,
     -92.00,    0.00,   75.00,
     -92.00,   12.00,   75.00,
    -100.00,   12.00,   84.00,
    -100.00,    0.00,   84.00,
    -108.00,    0.00,   75.00,
    -108.00,   12.00,   75.00,
    -120.00,   12.00,   84.00,
    -120.00,    0.00,   84.00,
    -108.00,    0.00,   66.00,
    -108.00,   12.00,   66.00,
    -120.00,   12.00,   66.00,
    -120.00,    0.00,   66.00,
    // 13
     -60.00,    0.00,   84.00,
     -60.00,  -12.00,   84.00,
     -64.00,  -12.00,   75.00,
     -64.00,    0.00,   75.00,
    -100.00,    0.00,   84.00,
    -100.00,  -12.00,   84.00,
     -92.00,  -12.00,   75.00,
     -92.00,    0.00,   75.00,
    -120.00,    0.00,   84.00,
    -120.00,  -12.00,   84.00,
    -108.00,  -12.00,   75.00,
    -108.00,    0.00,   75.00,
    -120.00,    0.00,   66.00,
    -120.00,  -12.00,   66.00,
    -108.00,  -12.00,   66.00,
    -108.00,    0.00,   66.00,
    // 14
    -108.00,    0.00,   66.00,
    -108.00,   12.00,   66.00,
    -120.00,   12.00,   66.00,
    -120.00,    0.00,   66.00,
    -108.00,    0.00,   57.00,
    -108.00,   12.00,   57.00,
    -120.00,   12.00,   48.00,
    -120.00,    0.00,   48.00,
    -100.00,    0.00,   39.00,
    -100.00,   12.00,   39.00,
    -106.00,   12.00,   31.50,
    -106.00,    0.00,   31.50,
     -80.00,    0.00,   30.00,
     -80.00,   12.00,   30.00,
     -76.00,   12.00,   18.00,
     -76.00,    0.00,   18.00,
    // 15
    -120.00,    0.00,   66.00,
    -120.00,  -12.00,   66.00,
    -108.00,  -12.00,   66.00,
    -108.00,    0.00,   66.00,
    -120.00,    0.00,   48.00,
    -120.00,  -12.00,   48.00,
    -108.00,  -12.00,   57.00,
    -108.00,    0.00,   57.00,
    -106.00,    0.00,   31.50,
    -106.00,  -12.00,   31.50,
    -100.00,  -12.00,   39.00,
    -100.00,    0.00,   39.00,
     -76.00,    0.00,   18.00,
     -76.00,  -12.00,   18.00,
     -80.00,  -12.00,   30.00,
     -80.00,    0.00,   30.00,
    // 16
     68.00,    0.00,   51.00,
     68.00,   26.40,   51.00,
     68.00,   26.40,   18.00,
     68.00,    0.00,   18.00,
    104.00,    0.00,   51.00,
    104.00,   26.40,   51.00,
    124.00,   26.40,   27.00,
    124.00,    0.00,   27.00,
     92.00,    0.00,   78.00,
     92.00,   10.00,   78.00,
     96.00,   10.00,   75.00,
     96.00,    0.00,   75.00,
    108.00,    0.00,   90.00,
    108.00,   10.00,   90.00,
    132.00,   10.00,   90.00,
    132.00,    0.00,   90.00,
    // 17
     68.00,    0.00,   18.00,
     68.00,  -26.40,   18.00,
     68.00,  -26.40,   51.00,
     68.00,    0.00,   51.00,
    124.00,    0.00,   27.00,
    124.00,  -26.40,   27.00,
    104.00,  -26.40,   51.00,
    104.00,    0.00,   51.00,
     96.00,    0.00,   75.00,
     96.00,  -10.00,   75.00,
     92.00,  -10.00,   78.00,
     92.00,    0.00,   78.00,
    132.00,    0.00,   90.00,
    132.00,  -10.00,   90.00,
    108.00,  -10.00,   90.00,
    108.00,    0.00,   90.00,
    // 18
    108.00,    0.00,   90.00,
    108.00,   10.00,   90.00,
    132.00,   10.00,   90.00,
    132.00,    0.00,   90.00,
    112.00,    0.00,   93.00,
    112.00,   10.00,   93.00,
    141.00,   10.00,   93.75,
    141.00,    0.00,   93.75,
    116.00,    0.00,   93.00,
    116.00,    6.00,   93.00,
    138.00,    6.00,   94.50,
    138.00,    0.00,   94.50,
    112.00,    0.00,   90.00,
    112.00,    6.00,   90.00,
    128.00,    6.00,   90.00,
    128.00,    0.00,   90.00,
    // 19
    132.00,    0.00,   90.00,
    132.00,  -10.00,   90.00,
    108.00,  -10.00,   90.00,
    108.00,    0.00,   90.00,
    141.00,    0.00,   93.75,
    141.00,  -10.00,   93.75,
    112.00,  -10.00,   93.00,
    112.00,    0.00,   93.00,
    138.00,    0.00,   94.50,
    138.00,   -6.00,   94.50,
    116.00,   -6.00,   93.00,
    116.00,    0.00,   93.00,
    128.00,    0.00,   90.00,
    128.00,   -6.00,   90.00,
    112.00,   -6.00,   90.00,
    112.00,    0.00,   90.00,
    // 20
     50.00,    0.00,   90.00,
     50.00,   28.00,   90.00,
     28.00,   50.00,   90.00,
      0.00,   50.00,   90.00,
     52.00,    0.00,   90.00,
     52.00,   29.12,   90.00,
     29.12,   52.00,   90.00,
      0.00,   52.00,   90.00,
     54.00,    0.00,   90.00,
     54.00,   30.24,   90.00,
     30.24,   54.00,   90.00,
      0.00,   54.00,   90.00,
     56.00,    0.00,   90.00,
     56.00,   31.36,   90.00,
     31.36,   56.00,   90.00,
      0.00,   56.00,   90.00,
    // 21
      0.00,   50.00,   90.00,
    -28.00,   50.00,   90.00,
    -50.00,   28.00,   90.00,
    -50.00,    0.00,   90.00,
      0.00,   52.00,   90.00,
    -29.12,   52.00,   90.00,
    -52.00,   29.12,   90.00,
    -52.00,    0.00,   90.00,
      0.00,   54.00,   90.00,
    -30.24,   54.00,   90.00,
    -54.00,   30.24,   90.00,
    -54.00,    0.00,   90.00,
      0.00,   56.00,   90.00,
    -31.36,   56.00,   90.00,
    -56.00,   31.36,   90.00,
    -56.00,    0.00,   90.00,
    // 22
    -50.00,    0.00,   90.00,
    -50.00,  -28.00,   90.00,
    -28.00,  -50.00,   90.00,
      0.00,  -50.00,   90.00,
    -52.00,    0.00,   90.00,
    -52.00,  -29.12,   90.00,
    -29.12,  -52.00,   90.00,
      0.00,  -52.00,   90.00,
    -54.00,    0.00,   90.00,
    -54.00,  -30.24,   90.00,
    -30.24,  -54.00,   90.00,
      0.00,  -54.00,   90.00,
    -56.00,    0.00,   90.00,
    -56.00,  -31.36,   90.00,
    -31.36,  -56.00,   90.00,
      0.00,  -56.00,   90.00,
    // 23
      0.00,  -50.00,   90.00,
     28.00,  -50.00,   90.00,
     50.00,  -28.00,   90.00,
     50.00,    0.00,   90.00,
      0.00,  -52.00,   90.00,
     29.12,  -52.00,   90.00,
     52.00,  -29.12,   90.00,
     52.00,    0.00,   90.00,
      0.00,  -54.00,   90.00,
     30.24,  -54.00,   90.00,
     54.00,  -30.24,   90.00,
     54.00,    0.00,   90.00,
      0.00,  -56.00,   90.00,
     31.36,  -56.00,   90.00,
     56.00,  -31.36,   90.00,
     56.00,    0.00,   90.00,
    // 24
     8.00,    0.00,  102.00,
     8.00,    4.48,  102.00,
     4.48,    8.00,  102.00,
     0.00,    8.00,  102.00,
    16.00,    0.00,   96.00,
    16.00,    8.96,   96.00,
     8.96,   16.00,   96.00,
     0.00,   16.00,   96.00,
    52.00,    0.00,   96.00,
    52.00,   29.12,   96.00,
    29.12,   52.00,   96.00,
     0.00,   52.00,   96.00,
    52.00,    0.00,   90.00,
    52.00,   29.12,   90.00,
    29.12,   52.00,   90.00,
     0.00,   52.00,   90.00,
    // 25
      0.00,    8.00,  102.00,
     -4.48,    8.00,  102.00,
     -8.00,    4.48,  102.00,
     -8.00,    0.00,  102.00,
      0.00,   16.00,   96.00,
     -8.96,   16.00,   96.00,
    -16.00,    8.96,   96.00,
    -16.00,    0.00,   96.00,
      0.00,   52.00,   96.00,
    -29.12,   52.00,   96.00,
    -52.00,   29.12,   96.00,
    -52.00,    0.00,   96.00,
      0.00,   52.00,   90.00,
    -29.12,   52.00,   90.00,
    -52.00,   29.12,   90.00,
    -52.00,    0.00,   90.00,
    // 26
      -8.00,    0.00,  102.00,
      -8.00,   -4.48,  102.00,
      -4.48,   -8.00,  102.00,
       0.00,   -8.00,  102.00,
     -16.00,    0.00,   96.00,
     -16.00,   -8.96,   96.00,
      -8.96,  -16.00,   96.00,
       0.00,  -16.00,   96.00,
     -52.00,    0.00,   96.00,
     -52.00,  -29.12,   96.00,
     -29.12,  -52.00,   96.00,
       0.00,  -52.00,   96.00,
     -52.00,    0.00,   90.00,
     -52.00,  -29.12,   90.00,
     -29.12,  -52.00,   90.00,
       0.00,  -52.00,   90.00,
    // 27
       0.00,   -8.00,  102.00,
       4.48,   -8.00,  102.00,
       8.00,   -4.48,  102.00,
       8.00,    0.00,  102.00,
       0.00,  -16.00,   96.00,
       8.96,  -16.00,   96.00,
      16.00,   -8.96,   96.00,
      16.00,    0.00,   96.00,
       0.00,  -52.00,   96.00,
      29.12,  -52.00,   96.00,
      52.00,  -29.12,   96.00,
      52.00,    0.00,   96.00,
       0.00,  -52.00,   90.00,
      29.12,  -52.00,   90.00,
      52.00,  -29.12,   90.00,
      52.00,    0.00,   90.00,
    // 28
     0.00,    0.00,  120.00,
     0.00,    0.00,  120.00,
     0.00,    0.00,  120.00,
     0.00,    0.00,  120.00,
    32.00,    0.00,  120.00,
    32.00,   18.00,  120.00,
    18.00,   32.00,  120.00,
     0.00,   32.00,  120.00,
     0.00,    0.00,  108.00,
     0.00,    0.00,  108.00,
     0.00,    0.00,  108.00,
     0.00,    0.00,  108.00,
     8.00,    0.00,  102.00,
     8.00,    4.48,  102.00,
     4.48,    8.00,  102.00,
     0.00,    8.00,  102.00,
    // 29
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,   32.00,  120.00,
    -18.00,   32.00,  120.00,
    -32.00,   18.00,  120.00,
    -32.00,    0.00,  120.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    8.00,  102.00,
     -4.48,    8.00,  102.00,
     -8.00,    4.48,  102.00,
     -8.00,    0.00,  102.00,
    // 30
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
    -32.00,    0.00,  120.00,
    -32.00,  -18.00,  120.00,
    -18.00,  -32.00,  120.00,
      0.00,  -32.00,  120.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
     -8.00,    0.00,  102.00,
     -8.00,   -4.48,  102.00,
     -4.48,   -8.00,  102.00,
      0.00,   -8.00,  102.00,
    // 31
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,    0.00,  120.00,
      0.00,  -32.00,  120.00,
     18.00,  -32.00,  120.00,
     32.00,  -18.00,  120.00,
     32.00,    0.00,  120.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,    0.00,  108.00,
      0.00,   -8.00,  102.00,
      4.48,   -8.00,  102.00,
      8.00,   -4.48,  102.00,
      8.00,    0.00,  102.00,

};

GL::Teapot::Teapot()
    : QObject(),
      Blob()
{
    setObjectName("teapot");

    Patch::DataList vertices;
    Patch::DataList normals;
    Patch::DataList texcoords;
    Patch::IndexList indices;

    Patch::VectorList cps;
    int i_offset = 0;
    int e_offset = 0;
    for (int k = 0; k < 32; ++k) {
        cps.clear();
        for (int m = 0; m < 16; ++m) {
            cps.append(Math3D::Vector4(control_points + 3*(16*k + m)) * 0.04);
        }
        Patch p(cps);
        p.gendata(10);
        vertices.append(p.vertices());
        normals.append(p.normals());
        texcoords.append(p.texcoords());
        foreach(Patch::Strip s, p.strips()) {
            Patch::IndexList strip;
            for (int idx = 0; idx < s.indices.length(); ++idx)
                strip.append(s.indices[idx] + i_offset);
            mElements.append(Element(s.mode, s.indices.length(), e_offset));
            e_offset += sizeof(GLuint) * s.indices.length();
            indices.append(strip);
        }
        i_offset += p.vertices().length() / 3;
    }

    int len1 = sizeof(float) * vertices.length();
    int len2 = sizeof(float) * normals.length();
    int len3 = sizeof(float) * texcoords.length();
    // num components, type, is normalized, packing offset, data offset
    mSpecs["vertex"] = BlobSpec(3, GL_FLOAT, false, 0, 0);
    mSpecs["normal"] = BlobSpec(3, GL_FLOAT, true, 0, len1);
    mSpecs["tex"] = BlobSpec(2, GL_FLOAT, false, 0, len1 + len2);

    char* data = (char*) ::malloc(len1 + len2 + len3);
    QVector<float> datavec = vertices.toVector();
    ::memcpy(data, datavec.constData(), len1);
    datavec = normals.toVector();
    ::memcpy(data + len1, datavec.constData(), len2);
    datavec = texcoords.toVector();
    ::memcpy(data + len1 + len2, datavec.constData(), len3);

    mData[GL_ARRAY_BUFFER] = Data(data, len1 + len2 + len3);


    int len4 = sizeof(GLuint) * indices.length();
    data = (char*) ::malloc(len4);
    QVector<GLuint> idata = indices.toVector();
    ::memcpy(data, idata.constData(), len4);
    mData[GL_ELEMENT_ARRAY_BUFFER] = Data(data, len4);

    mSupported[GL_TRIANGLES] = 0;
    mSupported[GL_LINES] = 0;
    mSupported[GL_POINTS] = 0;

    ModeMap triangle_strip;
    triangle_strip[GL_TRIANGLES] = GL_TRIANGLE_STRIP;
    triangle_strip[GL_LINES] = GL_LINE_STRIP;
    triangle_strip[GL_POINTS] = GL_POINTS;

    mModes[GL_TRIANGLE_STRIP] = triangle_strip;

    ModeMap triangles;
    triangles[GL_TRIANGLES] = GL_TRIANGLES;
    triangles[GL_LINES] = GL_LINES;
    triangles[GL_POINTS] = GL_POINTS;

    mModes[GL_TRIANGLES] = triangles;
}


void GL::Teapot::draw(unsigned int mode) const {
    if (!mSupported.contains(mode)) return;
    foreach (Element item, mElements) {
        glDrawElements((GLenum) mModes[item.mode][mode], (GLsizei) item.count, GL_UNSIGNED_INT, (void*) item.offset);
    }
}

GL::Teapot::~Teapot() {
    foreach(Data c, mData.values()) {
        delete (char*) c.data;
    }
}

Q_EXPORT_PLUGIN2(pnp_gl_teapot, GL::Teapot)
